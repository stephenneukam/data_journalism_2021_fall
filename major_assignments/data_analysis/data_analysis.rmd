---
title: "Data_analysis.rmd"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
## Loading essential libraries
#install.packages("readxl")
library(tidyverse)
library(tidycensus)
library(janitor)
library(tigris)
library(naniar)
library(readxl)
library(rvest)
library(corrr)

## Loading in homicide data

homicide_data <- read_csv("data/homicide-data.csv")

## As Baltimore crosses the 300 mark for homicides this year, a flood of explanations for the murders have emerged. Finger pointing in the city and state has continued, with different actors and departments assigning blame to different areas. Some in the city contend that the police do not have enough resources to combat the violence. Some, like Mayor Brandon Scott, argue that the violence stems from underlying factors, like years and years of poverty and a lack of funding for education. To test these arguments, we aggregated data points for a number of variables to see whether there was a statistical correlation between them and homicides across the nation. Through our data analysis, we pulled in datasets regarding police budgets, poverty rates and education in regards to the Baltimore area.


## Before getting started, we need to clean the homicide data a bit. Let's do that first:

## The age column is a character, but to work with the age of those killed, it has to be a dbl. For this, we have to first make all "Unknown" entries into N/A so that we can make this change

homicide_data_cleaned <- homicide_data %>%
  mutate(victim_age = na_if(victim_age, "Unknown"))

## Changing column to numeric

homicide_data_cleaned <- homicide_data_cleaned %>%
  mutate(victim_age = as.numeric(victim_age))

## We also need to load in homicide data

pop_url <- "https://ballotpedia.org/Largest_cities_in_the_United_States_by_population"

city_pop <- pop_url %>%
  read_html() %>%
  html_table()

city_pop <- city_pop[[2]]

## Writing it as a csv so we can load it back in and skip the first row.

write_csv(city_pop, "data/city_pops.csv")

city_pop <- read_csv("data/city_pops.csv", skip = 1)

## This dataset is a bit messy. We are going to clean it up, giving it correct column names and only grabbing the columns we need.

city_pop <- city_pop %>%
  mutate(population = `Population (2013)`) %>%
  select(City, population) %>%
  separate(City, into = c("City","State"), sep = ", ")

city_pop <- city_pop %>%
  select(City, population)

## This dataframe is missing population numbers for Savannah and Washington. We will input those number manually.

city_pop <- city_pop %>%
  add_row(City = "Savannah", population = 145403) %>%
  add_row(City = "Washington", population = 692683)

## Now we are going to join the population data into the homicide data

homicide_data_cleaned <- homicide_data_cleaned %>%
  inner_join(city_pop, by=c("city" = "City"))

homicide_data_cleaned %>%
  group_by(city) %>%
  count()

## One of the questions we wanted to look at was how the size of police budgets affects the homicide rate in cities. In 2020, Baltimore had the ninth overall largest police budget out of U.S. cities and the highest money spent per resident. In Baltimore alone, this would suggest that there was no correlation between a high police budget and the murder rate. However, if parsed out nationally, do we see a trend between murders and the size of police budgets? Does this suggest this could be an underlying factor? Let's see what the data suggests:

## Loading in police budget data

budget_url <- "https://storage.googleapis.com/vera-web-assets/data/datasets/City-PD_HoverStats-12-2-2020-2.csv"

budget <- read.csv(budget_url)

budget <- budget %>%
  select(City, State.Code, City...per.resident.for.police)

homicide_budegt <- homicide_data_cleaned %>%
  left_join(budget, by=c("city"="City", "state" = "State.Code"))

homicide_budget <- na.omit(homicide_budegt)

homicide_budget <- homicide_budget %>%
  select(city, population, City...per.resident.for.police) %>%
  group_by(city, population, City...per.resident.for.police) %>%
  count()

homicide_budget <- homicide_budget %>%
  mutate(homicide_rate = (n/population)*100000) %>%
  arrange(desc(City...per.resident.for.police))

homicide_budget %>%
  ggplot() +
  geom_point(aes(x=City...per.resident.for.police,y=homicide_rate)) +
  geom_smooth(aes(x=City...per.resident.for.police,y=homicide_rate), method="lm")

cor.test(homicide_budget$City...per.resident.for.police, homicide_budget$homicide_rate) 

## The statistics suggest that as police budget spending per city resident increases, so do homicide rates. The statistical significance of this analysis, however, makes us a bit skeptical that it is something we could report. The cor.test shows a p-value of .04728 and the r is .3283. We also considered that police budget spending may not be the most effective way to gauge whether policing in the cities makes a difference. For example, in Baltimore, there is consistent conversation over what some people see as aggressive or not aggressive enough policing tactics in the city. There is also argument over how the city prosecutes crimes, and whether that contributes to keeping violent offenders on the streets. However, this is data that we thought would be hard to quantify. But this type of analysis might be more instructive. For example, if we could come up with a data set that shows which cities prosecute low-level drug offenders vs. those that don't, we might be able to find more telling correlations.

## One of the other data points that we wanted to test homicide rates against was poverty rates. People like Mayor Scott have argued that underlying issues, such as poverty, have contributed to the rising homicide rates. Is there a connection between cities with higher poverty rates and higher homicide rates? We loaded in Census API data for each city. It shows the percent of population living 100 percent below the poverty line. Here's how we did that:

## We have to first load in income data for each city/

acs5 <- load_variables(2019, "acs5", cache = TRUE)

below_poverty_level <- get_acs(geography = "place",
                               variables = "B06012_002",
                               cache = TRUE)

below_poverty_level_cleaned <- below_poverty_level %>%
  select(NAME, estimate) %>%
  separate(NAME, into = c("City","State"), sep = ", ")

below_poverty_level_cleaned <- below_poverty_level_cleaned %>%
  select(City, estimate, State) %>%
  mutate(City = str_remove_all(City, " city")) %>%
  mutate(pop_below_poverty_line = estimate) %>%
  mutate(State = state.abb[match(below_poverty_level_cleaned$State, state.name)])

below_poverty_level_cleaned <- below_poverty_level_cleaned %>%
  select(City, State, pop_below_poverty_line)

## Now we have to join the poverty data to the homicide and population data

homicide_poverty <- homicide_data_cleaned %>%
  left_join(below_poverty_level_cleaned, by=c("city"="City", "state"="State"))

## Now we are going to calculate the percent of population in each city that is under 100% of the poverty line

homicide_poverty <- homicide_poverty %>%
  mutate(percent_poverty = (pop_below_poverty_line/population)*100)

## Now lets find the homicide rate for each city and rank which cities have the highest homicide rates (per 100000 people). We should be able to see if there is any correlation between poverty rate and homicide rate.

homicide_poverty <- homicide_poverty %>%
  select(city, population, percent_poverty) %>%
  group_by(city, population, percent_poverty) %>%
  count()

homicide_poverty <- homicide_poverty %>%
  mutate(homicide_rate = (n/population)*100000) %>%
  arrange(desc(percent_poverty))

homicide_poverty <- na.omit(homicide_poverty)

top_poverty <- homicide_poverty %>%
  filter(percent_poverty > 19)

bottom_poverty <- homicide_poverty %>%
  filter(percent_poverty < 19)

top_poverty %>%
  summarise(mean = mean(top_poverty$homicide_rate)) %>%
  ungroup() %>%
  slice(1) %>%
  select(mean)#212.6915

bottom_poverty %>%
  summarise(mean = mean(bottom_poverty$homicide_rate)) #113.3883

homicide_poverty %>%
  ggplot() +
  geom_point(aes(x=percent_poverty,y=homicide_rate)) +
  geom_smooth(aes(x=percent_poverty,y=homicide_rate), method="lm")

cor.test(homicide_poverty$percent_poverty, homicide_poverty$homicide_rate) ## good correlation

## The statistical tests suggest that there is a pretty good positive correlation between poverty rates and homicide rates. In general, as poverty rates increase, so do homicide rates. We would feel comfortable reporting this finding because the p-value of the two data points is .00065 and the r is .489. In this way, Baltimore is not unique from other cities with high homicide rates. However, we found that while Baltimore was in the top half of the cities in poverty rates, it sat relatively low in that half â€” it had the 18th-highest poverty rate but the second-highest murder rate. We acknowledge, though, that quantifying poverty in this manner is super broad. We also know that there are additional underlying issues that contribute to poverty. We tried to evaluate some of those more specific factors. One of those that we identified was education spending. We used a random sample of the top 50 cities and their per pupil spending on public education. We paired that with the homicide rates for each city to see if there was any correlation. Here's how we did that:

## Loading in education data

ed_spending <- read.csv("data/ed_spending.csv")

## cleaning ed data

ed_spending <- ed_spending %>%
  slice(-6,-15, -18, -22,-27) %>%
  mutate(Per_pupil_spending = as.numeric(Per_pupil_spending))

homicide_education <- homicide_data_cleaned %>%
  left_join(ed_spending, by=c("city"="City"))

homicide_education <-  na.omit(homicide_education)

homicide_education <- homicide_education %>%
  select(city, population, Per_pupil_spending) %>%
  group_by(city, population, Per_pupil_spending) %>%
  count()

homicide_education <- homicide_education %>%
  mutate(homicide_rate = (n/population)*100000) %>%
  arrange(desc(Per_pupil_spending))

homicide_education %>%
  ggplot() +
  geom_point(aes(x=Per_pupil_spending,y=homicide_rate)) +
  geom_smooth(aes(x=Per_pupil_spending,y=homicide_rate), method="lm")

cor.test(homicide_education$Per_pupil_spending, homicide_education$homicide_rate) ## no correlation

## The data shows that there was not correlation between per pupil spending and homicide rates. For what it is worth, Baltimore had the fifth-highest per pupil spending of the 24 cities we evaluated. This data is insignificant and not something that we would include in our reporting â€” or perhaps mention that we found no connection between the two. We also know that maybe there are more precise variables that might be better to evaluate â€” like how exactly public education funds are allotted.


## Question 4: Cities where the young get murdered. What cities have the highest rate of killings of people under 21? What cities have the most killings of people under 21? In 2012, the Chicago Reporter reported that more young Americans (under 21) die in Chicago than in any other city. Is this true still? It may have the highest total, but does it have the highest rate, which is more effective to adjust for population?


## To make it easier to count and group the number of killings uder 21, we are going to create a new column and call it "Under_21" and fill it with True and False if the age of the killed is under 21 or not.
homicide_data_cleaned <- homicide_data_cleaned %>%
  mutate(under_21 = if_else(victim_age < 21, "True", "False"))

## Change victim age back to numeric

homicide_data_cleaned <- homicide_data_cleaned %>%
  mutate(victim_age = as.numeric(victim_age))

## Now to find out which cities have the highest total of murders of people under 21. We will group by city and count the number of "True" results in the under_21 category for the cities.
under_21_totals <- homicide_data_cleaned %>%
  filter(under_21 == "True") %>%
  group_by(city,under_21) %>%
  count() %>%
  arrange(desc(under_21))

## We find that between 2010 and 2017, there were 1412 killings of people under 21 in Chicago, 575 in Philadelphia, 475 in Baltimore and 434 in Houston. We can conclude that, yes, Chicago is where the highest total of people under 21 get killed. In Chicago, what is the average age of those who get killed under 21?
homicide_data_cleaned %>%
  filter(city == "Chicago", under_21 == "True") %>%
  summarise(total_age = sum(victim_age)) %>%
  summarise(total_age/1412)

## The average age of those killed under 21 in Chicago is 16.75 years old. But, is Chicago where the highest rate of kids under 21 die? To find this out, we first need to add population data for each city. We're going to scrape a webpage that has populations for American cities.


## Back to calculating the rate of murders of people under 21.

under_21_rate <- homicide_data_cleaned %>%
  filter(under_21 == "True") %>%
  group_by(city,under_21, population) %>%
  count() %>%
  arrange(desc(under_21))

under_21_rate <- under_21_rate %>%
  mutate(homicide_rate = (n/population)*100000)

## We find that actually, St. Louis is the city where young people die at the highest rate, with 97 deaths per 100000 people. Baltimore, New Orleans and Birmingham follow, with Chicago at the fifth-highest rate. What is the average age of the people that are killed under the age of 21 in St. Louis? 

homicide_data_cleaned %>%
  filter(city == "St. Louis", under_21 == "True") %>%
  summarise(total_age = sum(victim_age)) %>%
  summarise(total_age/309)

## The average age is 17.39 years old. 


#Question 5: Which city has the highest amount of open cases? 
#first we should filter the data to see just our open cases 
unsolved_homicides <- homicide_data %>%
  filter(disposition=="Open/No arrest") %>%
  select(city, state, disposition)
#now we can find the totals for each city and arrange them spo we can see the city with the highest number of open cases 
unsolved_homicides_clean <- unsolved_homicides %>%
   mutate(city= str_to_title(city)) %>%
    group_by(city) %>%
    summarise(disposition = n()) %>%
    arrange(desc(disposition))
#As we can see, Chicago has the most unsolved homicides with 3686. Baltimore is second with 1673 folowed by Detroit with 146.
```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r cars}
summary(cars)
```

## Including Plots

You can also embed plots, for example:

```{r pressure, echo=FALSE}
plot(pressure)
```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
